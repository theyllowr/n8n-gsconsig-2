name: Build and Push n8n Custom to Artifact Registry

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite executar manualmente
    inputs:
      n8n_version:
        description: 'N8N version to build (e.g., latest, 1.65.2)'
        required: false
        default: 'latest'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  ARTIFACT_REGISTRY_REGION: us-central1  # Ajustar conforme sua regiÃ£o
  ARTIFACT_REGISTRY_REPO: n8n  # Nome do repositÃ³rio criado na interface
  IMAGE_NAME: n8n-custom

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout n8n-bypass repository
        uses: actions/checkout@v4

      - name: ðŸ” Determine N8N version
        run: |
          N8N_VERSION="${{ github.event.inputs.n8n_version || 'latest' }}"
          echo "N8N_VERSION=$N8N_VERSION" >> $GITHUB_ENV
          echo "âœ… Will build n8n version: $N8N_VERSION"

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ðŸ› ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ”§ Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev

      - name: ðŸ“ Create patch script for runtime
        run: |
          mkdir -p /tmp/n8n-custom
          cat > /tmp/n8n-custom/apply-runtime-patch.sh << 'PATCH_EOF'
          #!/bin/sh
          set -e
          
          echo "ðŸ©¹ Applying license bypass patches at runtime..."
          
          # Patch 1: License.ts - MÃ©todo isLicensed (bypass global)
          LICENSE_FILE="/usr/local/lib/node_modules/n8n/dist/license/License.js"
          if [ -f "$LICENSE_FILE" ]; then
            echo "ðŸ“ Patching $LICENSE_FILE..."
            sed -i 's/isLicensed(feature) {/isLicensed(feature) { return true; \/\/ BYPASS/' "$LICENSE_FILE"
            echo "âœ… License.ts patched"
          fi
          
          # Patch 2: License-state.ts
          LICENSE_STATE_FILE="/usr/local/lib/node_modules/n8n/dist/license-state.js"
          if [ -f "$LICENSE_STATE_FILE" ]; then
            echo "ðŸ“ Patching $LICENSE_STATE_FILE..."
            sed -i 's/isLicensed(feature) {/isLicensed(feature) { return true; \/\/ BYPASS/' "$LICENSE_STATE_FILE"
            echo "âœ… License-state.ts patched"
          fi
          
          echo "ðŸŽ‰ All patches applied successfully!"
          PATCH_EOF
          
          chmod +x /tmp/n8n-custom/apply-runtime-patch.sh

      - name: ðŸ“ Create custom Dockerfile
        run: |
          cat > /tmp/n8n-custom/Dockerfile << 'DOCKERFILE_EOF'
          ARG N8N_VERSION=latest
          FROM n8nio/n8n:${N8N_VERSION}
          
          USER root
          
          # Copiar script de patch
          COPY apply-runtime-patch.sh /docker-entrypoint.d/apply-runtime-patch.sh
          RUN chmod +x /docker-entrypoint.d/apply-runtime-patch.sh
          
          # Aplicar patches
          RUN /docker-entrypoint.d/apply-runtime-patch.sh
          
          USER node
          
          LABEL maintainer="GSConsig"
          LABEL description="N8N with enterprise license bypass"
          LABEL version="${N8N_VERSION}"
          DOCKERFILE_EOF

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Docker image (AMD64 only)
        run: |
          cd /tmp/n8n-custom
          
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ env.N8N_VERSION }}"
          IMAGE_TAG_LATEST="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "ðŸ—ï¸ Building Docker image (linux/amd64): $IMAGE_TAG"
          echo "ðŸ“¦ Base image: n8nio/n8n:${{ env.N8N_VERSION }}"
          
          docker buildx build \
            --platform linux/amd64 \
            --tag "$IMAGE_TAG" \
            --tag "$IMAGE_TAG_LATEST" \
            --build-arg N8N_VERSION="${{ env.N8N_VERSION }}" \
            --file Dockerfile \
            --load \
            .
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG_LATEST=$IMAGE_TAG_LATEST" >> $GITHUB_ENV

      - name: ðŸš€ Push to Artifact Registry
        run: |
          echo "ðŸ“¤ Pushing images to Artifact Registry..."
          
          docker push ${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_TAG_LATEST }}
          
          echo "âœ… Images pushed successfully!"
          echo "ðŸ“¦ Image: ${{ env.IMAGE_TAG }}"
          echo "ðŸ“¦ Latest: ${{ env.IMAGE_TAG_LATEST }}"

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **N8N Version:** ${{ env.N8N_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Tag:** \`${{ env.IMAGE_TAG_LATEST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Applied Patches" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… License bypass (global)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quota bypass (unlimited)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… License state bypass" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_TAG_LATEST }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
